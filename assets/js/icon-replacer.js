// Roam Foam - Custom Icon Replacer
// Auto-generated from SVG files and icon mappings

const IconReplacer = {
  // SVG icons (auto-generated from assets/icons/source/)
  icons: {
        'calendar': `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" ><g class="oi-calendar-dates"><path class="oi-vector" d="M4 6C4 5.44772 4.44772 5 5 5H19C19.5523 5 20 5.44772 20 6V19C20 19.5523 19.5523 20 19 20H5C4.44772 20 4 19.5523 4 19V6Z" stroke="currentColor" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" /><path class="oi-line" d="M9 7L9 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" /><path class="oi-line" d="M3.99997 10L20 10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" /><path class="oi-line" d="M15 7L15 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" /><rect class="oi-mini-square" x="7.5" y="13.5" width="0.1" height="0.1" stroke="currentColor" stroke-width="1.50" /><rect class="oi-mini-square" x="7.5" y="16.5" width="0.1" height="0.1" stroke="currentColor" stroke-width="1.50" /><rect class="oi-mini-square" x="10.5" y="13.5" width="0.1" height="0.1" stroke="currentColor" stroke-width="1.50" /><rect class="oi-mini-square" x="10.5" y="16.5" width="0.1" height="0.1" stroke="currentColor" stroke-width="1.50" /><rect class="oi-mini-square" x="13.5" y="13.5" width="0.1" height="0.1" stroke="currentColor" stroke-width="1.50" /><rect class="oi-mini-square" x="13.5" y="16.5" width="0.1" height="0.1" stroke="currentColor" stroke-width="1.50" /><rect class="oi-mini-square" x="16.5" y="13.5" width="0.1" height="0.1" stroke="currentColor" stroke-width="1.50" /><rect class="oi-mini-square" x="16.5" y="16.5" width="0.1" height="0.1" stroke="currentColor" stroke-width="1.50" /></g></svg>`,
    'caret-down': `<svg viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M4.427 6.427a.75.75 0 0 1 1.06 0L8 8.94l2.513-2.513a.75.75 0 1 1 1.06 1.06L8.707 10.353a.5.5 0 0 1-.707 0L5.133 7.487a.75.75 0 0 1-.706-1.06z"/></svg>`,
    'filter': `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" ><g class="oi-filter"><path class="oi-vector" d="M22 3.5H2L10 12.96V19.5L14 21.5V12.96L22 3.5Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" /></g></svg>`,
    'kebab': `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" ><g class="oi-options-horizontal[more]"><path class="oi-dot" d="M18.006 11.994L18.006 12.006" stroke="currentColor" stroke-width="3.00" stroke-linecap="round" /><path class="oi-dot" d="M12.006 11.994L12.006 12.006" stroke="currentColor" stroke-width="3.00" stroke-linecap="round" /><path class="oi-dot" d="M6.00598 11.994L6.00598 12.006" stroke="currentColor" stroke-width="3.00" stroke-linecap="round" /></g></svg>`,
    'left-indent': `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" ><g class="oi-left-indent-text"><path class="oi-line" d="M13 6H21" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" /><path class="oi-line" d="M13 10H21" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" /><path class="oi-line" d="M13 14H21" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" /><path class="oi-line" d="M13 18H21" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" /><path class="oi-line" d="M9 6V18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" /><path class="oi-incomplete-triangle" d="M5 10L3 12L5 14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" /></g></svg>`,
    'question': `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" ><g class="oi-circle-question"><circle class="oi-ellipse" cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.5" /><path class="oi-vector" d="M9.14319 9.81599C9.31526 8.94849 9.93419 7.5 12.1711 7.5C13.5026 7.5 14.8568 8.39777 14.8568 10.4282C14.8568 12.3177 13.3889 12.9323 12.3371 13.0898C12.0094 13.1389 11.7399 13.4048 11.7399 13.7362V14.0083" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" /><path class="oi-mini-dot" d="M11.7285 17H11.7405" stroke="currentColor" stroke-width="1.50" stroke-linecap="round" /></g></svg>`,
    'width': `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14.168 4.16406L5.83464 4.16406" stroke="currentColor" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round"/><path d="M12.5013 5.83333L14.168 4.16667L12.5013 2.5" stroke="currentColor"  stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round"/><path d="M7.5 5.83333L5.83333 4.16667L7.5 2.5" stroke="currentColor"  stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round"/><path fill-rule="evenodd" clip-rule="evenodd" d="M4.66797 10.5026C4.66797 9.58213 5.41414 8.83594 6.33464 8.83594H13.668C14.5885 8.83594 15.3346 9.58213 15.3346 10.5026V16.5026C15.3346 17.4231 14.5885 18.1693 13.668 18.1693H6.33464C5.41414 18.1693 4.66797 17.4231 4.66797 16.5026V10.5026Z" stroke="currentColor"  stroke-width="1.25"/></svg>`
  },

  // Icon class mappings (class name -> SVG file name)
  mappings: {
        'bp3-icon-calendar': 'calendar',
    'bp3-icon-more': 'kebab',
    'bp3-icon-filter': 'filter',
    'bp3-icon-horizontal-distribution': 'width',
    'bp3-icon-help': 'question',
    'bp3-icon-menu-closed': 'left-indent'
  },

  // Track replaced elements to prevent loops
  replacedElements: new WeakSet(),
  isReplacing: false,

  // Initialize icon replacement
  init() {
    console.log("ðŸŽ¨ Roam Foam: Initializing custom icons...");
    console.log("ðŸ“‹ Available icons:", Object.keys(this.icons));
    console.log("ðŸ—ºï¸  Mappings:", this.mappings);

    // Replace existing icons
    this.replaceExistingIcons();

    // Watch for new icons (for dynamic content)
    this.watchForNewIcons();
  },

  // Replace icons that are already on the page
  replaceExistingIcons() {
    console.log("ðŸ” Scanning page for existing icons...");

    Object.entries(this.mappings).forEach(([className, iconKey]) => {
      console.log(`ðŸ”Ž Looking for class: ${className} -> ${iconKey}`);

      // Handle both with and without bp3- prefix
      const selectors = [
        `.${className}`,
        `.${className} svg`,
        `[class*="${className}"]`,
        `[class*="${className}"] svg`,
      ];

      selectors.forEach((selector) => {
        const elements = document.querySelectorAll(selector);
        console.log(
          `  ðŸ“Š Found ${elements.length} elements for selector: ${selector}`,
        );
        elements.forEach((el) => {
          console.log(`    ðŸŽ¯ Element:`, el.tagName, el.className);
          this.replaceIcon(el, iconKey, className);
        });
      });
    });
  },

  // Watch for dynamically added icons
  watchForNewIcons() {
    const observer = new MutationObserver((mutations) => {
      // Skip if we're currently replacing icons
      if (this.isReplacing) return;
      
      mutations.forEach((mutation) => {
        mutation.addedNodes.forEach((node) => {
          if (node.nodeType === Node.ELEMENT_NODE && 
              !this.replacedElements.has(node) &&
              !node.classList?.contains('roam-foam-custom-icon') &&
              !node.querySelector?.('.roam-foam-custom-icon')) {
            
            this.isReplacing = true;
            // Check if the new node or its children contain icons to replace
            Object.entries(this.mappings).forEach(([className, iconKey]) => {
              const selectors = [
                `.${className}`,
                `.${className} svg`,
                `[class*="${className}"]`,
                `[class*="${className}"] svg`,
              ];

              selectors.forEach((selector) => {
                let elements = [];

                // Check if the node itself matches
                if (node.matches && node.matches(selector)) {
                  elements.push(node);
                }

                // Check children
                if (node.querySelectorAll) {
                  elements.push(...node.querySelectorAll(selector));
                }

                elements.forEach((el) =>
                  this.replaceIcon(el, iconKey, className),
                );
              });
            });
            
            // Reset flag after processing
            setTimeout(() => {
              this.isReplacing = false;
            }, 100);
          }
        });
      });
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true,
    });
  },

  // Replace a single icon element
  replaceIcon(element, iconKey, className) {
    const svgContent = this.icons[iconKey];
    if (!svgContent) return;
    
    // Skip if already processed
    if (this.replacedElements.has(element) || 
        element.classList.contains('roam-foam-custom-icon')) {
      return;
    }
    
    // Mark as processed
    this.replacedElements.add(element);

    // For bp3-icon-* spans (most common case)
    if (element.tagName === "SPAN" && element.classList.contains(className)) {
      // Check if it has an SVG child first
      const svgChild = element.querySelector("svg");
      if (svgChild) {
        // Store original content if not already stored
        if (!svgChild.dataset.originalContent) {
          svgChild.dataset.originalContent = svgChild.outerHTML;
        }

        // Replace with custom SVG
        svgChild.outerHTML = svgContent;
        element.classList.add("roam-foam-custom-icon");

        console.log(`ðŸ”„ Replaced SVG child: ${iconKey} (${className})`);
      } else {
        // No SVG child - this is likely a pseudo-element icon
        // Store original state
        if (!element.dataset.originalContent) {
          element.dataset.originalContent = element.innerHTML;
          element.dataset.originalClass = element.className;
        }

        // Clear any existing content and inject our SVG
        element.innerHTML = svgContent;

        // Add CSS to hide the pseudo-element and show our SVG
        element.classList.add("roam-foam-custom-icon");
        element.style.cssText += `
          position: relative;
          display: inline-flex;
          align-items: center;
          justify-content: center;
        `;

        // Add CSS to hide the ::before pseudo-element
        if (!document.getElementById("roam-foam-icon-styles")) {
          const style = document.createElement("style");
          style.id = "roam-foam-icon-styles";
          style.textContent = `
            .roam-foam-custom-icon::before {
              display: none !important;
              content: none !important;
            }
            .roam-foam-custom-icon svg {
              width: 20px;
              height: 20px;
              flex-shrink: 0;
            }
          `;
          document.head.appendChild(style);
        }

        console.log(
          `ðŸ”„ Replaced pseudo-element icon: ${iconKey} (${className})`,
        );
      }
    }
    // For direct SVG elements
    else if (element.tagName === "svg") {
      // Store original content if not already stored
      if (!element.dataset.originalContent) {
        element.dataset.originalContent = element.outerHTML;
      }

      // Replace with custom SVG
      element.outerHTML = svgContent;

      console.log(`ðŸ”„ Replaced direct SVG: ${iconKey} (${className})`);
    }
  },

  // Restore original icons (useful for debugging)
  restoreOriginalIcons() {
    const customIcons = document.querySelectorAll(".roam-foam-custom-icon");
    customIcons.forEach((element) => {
      // Handle spans with SVG children
      const svgChild = element.querySelector("svg");
      if (svgChild && svgChild.dataset.originalContent) {
        svgChild.outerHTML = svgChild.dataset.originalContent;
      }
      // Handle pseudo-element replacements
      else if (element.dataset.originalContent !== undefined) {
        element.innerHTML = element.dataset.originalContent;
        if (element.dataset.originalClass) {
          element.className = element.dataset.originalClass;
        }
        element.style.cssText = "";
        delete element.dataset.originalContent;
        delete element.dataset.originalClass;
      }

      element.classList.remove("roam-foam-custom-icon");
    });

    // Also handle direct SVGs
    document.querySelectorAll("svg[data-original-content]").forEach((svg) => {
      svg.outerHTML = svg.dataset.originalContent;
    });

    // Remove injected styles
    const styleEl = document.getElementById("roam-foam-icon-styles");
    if (styleEl) {
      styleEl.remove();
    }

    console.log("ðŸ”„ Restored original icons");
  },
};

// Auto-initialize when DOM is ready
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", () => IconReplacer.init());
} else {
  IconReplacer.init();
}

// Make available globally for debugging
window.RoamFoamIconReplacer = IconReplacer;

